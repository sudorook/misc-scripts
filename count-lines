#! /bin/bash
set -eu
source globals

IGNOREFILES="-iname '*.pdf'\
             -o -iname '*.db'\
             -o -iname '*.bin'\
             -o -iname '*.dat'\
             -o -iname '.Rhistory'\
             -o -iname '*.doc*'\
             -o -iname '*.ppt*'\
             -o -iname '*.png'\
             -o -iname '*.svg'\
             -o -iname '*.jpg'\
             -o -iname '*.tiff?'\
             -o -iname '*.gif'\
             -o -name '.gitignore'\
             -o -name '.gitattributes'\
             -o -iname '*.sw[a-p]'\
             -o -iname '*~'\
             -o -iname '*.tar.*'\
             -o -iname '*.zip'\
             -o -iname '*.tgz'"
IGNOREDIRS="-name '.git'\
            -o -name '.github'\
            -o -name 'bin'\
            -o -name '.deps'\
            -o -name 'autom4te.cache'"

if [ $# -gt 1 ]; then
  show_warning "WARNING: Ignoring inputs ${*:2}."
fi

IN="${1:-.}"

if [ -f "${IN}" ]; then
  wc -l "${IN}"
elif [ -d "${IN}" ]; then
  if git -C "${IN}" rev-parse 2>/dev/null; then
    CMD="git -C ${IN@Q} ls-files -co --exclude-per-directory=.gitignore -z | find -files0-from -"
  else
    CMD="find ${IN@Q}"
  fi
  CMD="${CMD} \( ${IGNOREDIRS} \) -prune , -type f -not \( ${IGNOREFILES} \)"
  CMD="${CMD} -exec wc -l -- {} +"
  eval "${CMD}"
else
  show_error "ERROR: Unknown input ${1@Q}."
  exit 3
fi
