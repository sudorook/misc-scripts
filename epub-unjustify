#! /bin/bash
set -eu
source globals

FILE="${1}"
NAME="${1%.*}"
EXTENSION="${1##*.}"

if ! [[ "$(file -b --mime-type "${1}")" =~ epub ]]; then
  if ! [[ "${EXTENSION,,}" = epub ]]; then
    show_error "ERROR: Input not EPUB format."
    exit 3
  fi
fi

BUILDDIR="$(mktemp -d)"
trap 'rm -rf "${BUILDDIR}"; exit' INT TERM ERR EXIT

cp "${FILE}" "${BUILDDIR}"
pushd "${BUILDDIR}" >/dev/null

unzip "${FILE}"

# Remove hard-coded colors
find . -type f -name "*.css" \
  -exec sed -i "s,background-color\ *:\ *#\([0-9a-f]\+\);,/*background-color: \1;*/,g" {} \; \
  -exec sed -i "s,background-color\ *:\ *#\([0-9a-f]\+\)$,/*background-color: \1*/,g" {} \; \
  -exec sed -i "s,background-color\ *:\ *#\([0-9a-f]\+\)},/*background-color: \1*/},g" {} \;

find . -type f -name "*.css" \
  -exec sed -i "s,\(;*\ *\)color\ *:\ *#\([0-9a-f]\+\);,\1/*color: \2;*/,g" {} \; \
  -exec sed -i "s,\(;*\ *\)color\ *:\ *#\([0-9a-f]\+\)$,\1/*color: \2*/,g" {} \; \
  -exec sed -i "s,\(;*\ *\)color\ *:\ *#\([0-9a-f]\+\)},\1/*color: \2*/},g" {} \;

# Removed justified text
find . -type f -name "*.css" \
  -exec sed -i "s,text-align\s*:\s*justify;,/*text-align: justify;*/,g" {} \; \
  -exec sed -i "s,text-align\s*:\s*justify[\n\r]*$,/*text-align: justify*/,g" {} \; \
  -exec sed -i "s,text-align\s*:\s*justify},/*text-align: justify*/},g" {} \;

zip -u "${FILE}"

popd >/dev/null
mv "${BUILDDIR}/${FILE}" "${NAME} new.${EXTENSION}"
