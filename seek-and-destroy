#! /bin/bash
set -euo pipefail
source globals


#
# Global functions
#

if ! [[ -v projectdir ]]; then
  projectdir=${HOME}/Desktop
fi
if ! [[ -v pkgbuilddir ]]; then
  pkgbuilddir=${HOME}/Desktop
fi

function sloppy_seek {
  local inputstring=
  local item
  local cmd

  for item in "${@}"; do
    if [ -z "${inputstring}" ]; then
      inputstring="-iname \"*${item}*\" -o -iname \".*${item}*\""
    else
      inputstring="${inputstring} \
                   -o -iname \"*${item}*\" -o -iname \".*${item}*\""
    fi
  done

  cmd="find ${HOME}/ \
         \( -path \"${HOME}/Desktop\" \
            -o -path \"${HOME}/Documents\" \
            -o -path \"${HOME}/Downloads\" \
            -o -path \"${HOME}/Music\" \
            -o -path \"${HOME}/Pictures\" \
            -o -path \"${projectdir}\" \
            -o -path \"${HOME}/Public\" \
            -o -path \"${HOME}/Sync\" \
            -o -path \"${HOME}/Templates\" \
            -o -path \"${HOME}/Videos\" \
            -o -path \"${pkgbuilddir}\" \) -prune \
         -o \( ${inputstring} \) -print"

  eval "${cmd}" 2>/dev/null || true
}

function precise_seek {
  local inputstring=
  local item
  local cmd

  for item in "${@}"; do
    if [ -z "${inputstring}" ]; then
      inputstring="-name \"${item}\" -o -name \".${item}\" \
                   -o -name \".${item,,}\" -o -name \".${item,,}\" \
                   -o -name \".${item^,}\" -o -name \".${item^}\""
    else
      inputstring="${inputstring} \
                   -o -name \"${item}\" -o -name \".${item}\" \
                   -o -name \".${item,,}\" -o -name \".${item,,}\" \
                   -o -name \".${item^,}\" -o -name \".${item^}\""
    fi
  done

  cmd="find ${HOME}/ \
         \( -path \"${HOME}/Desktop\" \
            -o -path \"${HOME}/Documents\" \
            -o -path \"${HOME}/Downloads\" \
            -o -path \"${HOME}/Music\" \
            -o -path \"${HOME}/Pictures\" \
            -o -path \"${projectdir}\" \
            -o -path \"${HOME}/Public\" \
            -o -path \"${HOME}/Sync\" \
            -o -path \"${HOME}/Templates\" \
            -o -path \"${HOME}/Videos\" \
            -o -path \"${pkgbuilddir}\" \) -prune \
         -o \( ${inputstring} \) -print"

  eval "${cmd}" 2>/dev/null || true
}

function destroy {
  xargs -n 1 -exec rm -rf
  show_success "Target(s) eliminated."
}


#
# Parse command line options
#

OPTIONS="ps"
LONGOPTIONS=precise,sloppy
PARSED=$(getopt -o ${OPTIONS} --long ${LONGOPTIONS} -n "${0}" -- "${@}")
eval set -- "${PARSED}"
MODE=

while [ ${#} -ge 1 ]; do
  case ${1} in
    -p|--precise)
      MODE=precise
      shift
      ;;
    -s|--sloppy)
      MODE=sloppy
      shift
      ;;
    --)
      shift
      break
      ;;
    *)
      show_error "Error: invalid flag."
      exit 3
      ;;
  esac
done


#
# Run seeker and destroyer
#

if [ ${#} = 0 ]; then
  show_error "ERROR: no input(s) given. Exiting."
  exit 3
fi

RES=
case ${MODE} in
  precise)
    show_header "--- Running precise seeker ---"
    RES="$(precise_seek "${@}")"
    ;;
  sloppy)
    show_header "--- Running sloppy seeker ---"
    RES="$(sloppy_seek "${@}")"
    ;;
  *)
    show_error "Error: seeker mode ${MODE} is incorrect."
    exit 3
    ;;
esac

if [[ -n "${RES}" ]]; then
  echo "${RES}"
  check=$(ask_question 'Permission to destroy? (y/N)')
  if [[ ${check} =~ ^([yY][eE][sS]|[yY])$ ]]; then
    echo "Yessir!"
    echo "${RES}" | destroy
  else
    echo "As you wish..."
  fi
else
  echo "Target(s) not found. Standing down."
fi
