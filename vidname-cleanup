#! /bin/bash
set -euo pipefail
source globals

function get_language() {
  local res=
  for lang in "${!LANG[@]}"; do
    if [[ "${1,,}" = "${LANG[${lang}],,}" ]]; then
      res="${1}"
      break
    fi
  done

  # If language not found, try to parse three-character strings as a fallback.
  if [ -z "${res}" ]; then
    for lang in "${!LANG[@]}"; do
      if [[ "${1,,}" = "${lang,,}" ]]; then
        res="${1^^}"
        break
      fi
    done
  fi

  echo "${res}"
}

function cleanup_filename() {
  local name
  local extension
  local lang
  local newname

  name="${1%.*}"
  extension="${1##*.}"
  lang="$(echo "${name}" | sed -e "s/_\|\./\ /g" | grep -o '[^\ ]*$')"
  lang="$(get_language "${lang}")"
  newname=$(echo "${name}" | \
    sed -e "s/_\|\./\ /g" | \
    sed -e "s/^\[[^]]*\]\ \?//g" | \
    sed -e "s/\ \[[^()]*\]//g" | \
    sed -e "s/^([^()]*)\ \?//g" | \
    sed -e "s/\ ([^()]*)//g" | \
    sed -e "s/\(DVD\|HDTV\|BluRay\|WEB-DL\|BRRip\|DVDRip\|HDRip\).*//g" | \
    sed -e "s/\(x264\|x265\).*//g" | \
    sed -e "s/\(720\|1080\|480\|576\)p.*//g" | \
    sed -e "s/\ *\(19\|20\)\([0-9]\{2\}\)\ *$//g" | \
    sed -e "s/\b\(s[0-9][0-9]e[0-9][0-9]\)/\U\1/g" | \
    sed -e "s/\ \ \+/\ /g" | \
    sed -e "s/\ *$//g" | \
    sed -e "s/^\ *//g")

  if [ -z "${lang}" ]; then
    echo "${newname}.${extension}"
  else
    local tmp
    tmp="$(echo "${newname}" | grep -o '[^\ ]*$')"
    if [[ "${lang}" = "${tmp}" ]]; then
      echo "${newname}.${extension}"
    else
      echo "${newname} ${lang}.${extension}"
    fi
  fi
  return 0
}

for VID in *; do
  if [ -f "${VID}" ]; then
    ! [[ "$(file -b --mime-type "${VID}")" =~ video|text ]] && continue
    NEWVID=$(cleanup_filename "${VID}")
    echo "${NEWVID}"
  fi
done

REPLY=$(ask_question "Is this good? (y/N)")

if [[ "${REPLY}" =~ ^y ]] || [[ "${REPLY}" =~ ^Y ]]; then
  for VID in *; do
    if [ -f "${VID}" ]; then
      ! [[ "$(file -b --mime-type "${VID}")" =~ video|text ]] && continue
      NEWVID=$(cleanup_filename "${VID}")
      if [ "${VID}" != "${NEWVID}" ]; then
        mv -v "${VID}" "${NEWVID}"
      else
        echo "${VID} unchanged"
      fi
    fi
  done
else
  echo "Fine. Be that way."
  exit 1
fi
